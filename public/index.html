<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mildred â€” Attach & Preview Demo</title>
  <style>
    :root{
      --bg: #f7f7fb;
      --ink: #20222b;
      --ridge: #d9dce6;
      --ridge-2: #cbd0df;
      --accent-kingfisher: #2a7f9e; /* teal-blue */
      --accent-moss: #7aa37c;       /* moss green */
      --accent-amber: #f7b500;      /* warm amber */
      --font-sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Inter", "Noto Sans", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); background:var(--bg);
      font: 16px/1.35 var(--font-sans);
      /* subtle knit-esque crosshatch */
      background-image:
        repeating-linear-gradient(0deg, transparent, transparent 23px, #0001 24px),
        repeating-linear-gradient(90deg, transparent, transparent 23px, #0001 24px);
      background-blend-mode: multiply;
    }

    .wrap{
      max-width:920px; margin:0 auto; padding:24px; min-height:100%;
      display:grid; grid-template-rows: auto 1fr auto; gap:16px;
    }

    header{
      display:flex; align-items:center; gap:12px; padding:10px 0 0;
    }
    .logo{ width:36px; height:36px; border-radius:10px; display:grid; place-items:center; color:#fff;
      background: linear-gradient(135deg, var(--accent-kingfisher), var(--accent-moss));
      box-shadow: 0 2px 8px #0002;
      font: 700 18px/1 var(--font-sans);
    }
    h1{ margin:0; font-size:18px; letter-spacing:.2px }
    .sub{ color:#394056; opacity:.8; font-size:13px }

    main{
      display:grid;
      grid-template-rows: 1fr auto;
      gap:16px;
      min-height:0;
    }

    .thread{
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow-y:auto;
      padding-right:4px;
    }
    .thread:focus-visible{ outline:2px solid var(--accent-amber); outline-offset:2px }
    .msg{ display:grid; gap:8px; }
    .msg.user{ justify-items:end; }
    .msg.assistant{ justify-items:start; }
    .bubble{
      position:relative;
      max-width:min(100%, 560px);
      padding:12px 14px;
      border-radius:16px;
      background:#fff;
      border:1px solid var(--ridge);
      box-shadow:0 4px 16px #0001;
    }
    .msg.pending .bubble{ opacity:.85 }
    .msg.error .bubble{
      border-color: color-mix(in oklab, #d55 55%, var(--ridge));
      background: color-mix(in oklab, #fdd 45%, #fff);
      color:#4c1c1c;
      box-shadow:0 4px 14px #0002;
    }
    .msg.user .bubble{
      background: linear-gradient(135deg, var(--accent-moss), var(--accent-kingfisher));
      color:#f5fbff;
      border:0;
    }
    .files{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .files li{
      font: 12px/1.1 var(--font-mono);
      border:1px solid var(--ridge);
      background:#fff6;
      color:#364155;
      border-radius:999px;
      padding:4px 8px;
    }
    .msg.user .files li{
      border-color:#ffffff55;
      background:#ffffff22;
      color:#eef6ff;
    }

    /* Input bar */
    .inputbar{ position:sticky; bottom:0; backdrop-filter:saturate(1.1) blur(6px); padding:8px 0 16px; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin:0 0 10px 0; }
    .chip{
      border:1px solid var(--ridge); background:#fff8; color:#243044; cursor:pointer;
      border-radius:999px; padding:6px 10px; font: 13px/1 var(--font-sans);
    }
    .chip:focus-visible{ outline:2px solid var(--accent-amber); outline-offset:2px }

    .input{
      display:grid; grid-template-columns: 38px 1fr auto; gap:10px; align-items:center;
      background:#fff; border:1px solid var(--ridge); border-radius:14px; padding:8px 10px; box-shadow:0 1px 0 #fff inset, 0 8px 24px #0001;
      transition: border-color .15s ease, background-color .15s ease;
    }
    .input:focus-within{ border-color: var(--ridge-2) }

    .iconbtn{
      position: relative; /* for badge positioning */
      display:inline-grid; place-items:center; width:38px; height:38px; border-radius:999px;
      border:1px solid var(--ridge);
      background: var(--bg);
      background: color-mix(in oklab, var(--bg) 85%, #fff);
      color: var(--accent-kingfisher); cursor:pointer;
    }
    .iconbtn:focus-visible{ outline:3px solid var(--accent-amber); outline-offset:2px }

    /* Attachment count badge on paperclip */
    .iconbtn.attach[data-count]:after{
      content: attr(data-count);
      position:absolute; top:-6px; right:-6px; min-width:18px; height:18px; padding:0 4px;
      border-radius:999px; background:var(--accent-amber); color:#1a1400;
      font: 600 11px/18px var(--font-mono); text-align:center;
      box-shadow: 0 1px 4px #0003;
    }

    textarea{
      border:0; resize:none; min-height:38px; max-height:33vh; padding:8px 10px; border-radius:10px;
      font: 15px/1.35 var(--font-sans); color:var(--ink); background:transparent; outline:none;
    }

    .btn{
      position: relative; /* for optional badge */
      border:0; border-radius:10px; height:38px; padding:0 12px; cursor:pointer; white-space:nowrap;
      color:white; background:linear-gradient(135deg, var(--accent-moss), var(--accent-kingfisher));
      box-shadow: 0 2px 8px #0002;
      font: 14px/1 var(--font-sans);
    }
    .btn:focus-visible{ outline:3px solid var(--accent-amber); outline-offset:2px }
    .btn[data-count]:after{
      content: '(' attr(data-count) ')';
      margin-left:6px; font: 600 12px/1 var(--font-mono);
    }

    .dropzone{ transition: border-color .15s ease, background-color .15s ease; }
    .dropzone.dragover{
      background: var(--bg);
      background: color-mix(in oklab, var(--accent-kingfisher) 6%, var(--bg));
      border-style:dashed;
    }

    .previews{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .preview{
      display:flex; align-items:center; gap:8px; border:1px solid var(--ridge);
      border-radius:999px; padding:6px 10px; background:#fff2; max-width: 320px; backdrop-filter: blur(2px);
    }
    .preview .thumb{
      width:28px; height:28px; border-radius:6px; overflow:hidden; background:var(--ridge);
      display:grid; place-items:center; color:#fff; font: 12px var(--font-mono);
    }
    .preview .thumb img{ width:100%; height:100%; object-fit:cover; display:block }
    .preview .info{ display:flex; gap:6px; align-items:baseline }
    .preview .name{ font: 13px/1.2 var(--font-sans); max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .preview .size{ font: 12px/1 var(--font-mono); opacity:.7 }
    .preview .remove{ margin-left:4px; border:0; background:transparent; cursor:pointer; color:var(--ink); font-size:16px; line-height:1; padding:2px 6px; border-radius:6px }
    .preview .remove:focus-visible{ outline:2px solid var(--accent-amber) }

    .bar{ width:84px; height:6px; border-radius:999px; background:var(--ridge); overflow:hidden }
    .bar span{ display:block; height:100%; background:linear-gradient(90deg,var(--accent-moss),var(--accent-kingfisher)); width:var(--p,0%) }

    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip: rect(0,0,0,0); clip-path: inset(50%); border:0; white-space:nowrap; }

    footer{ color:#364155; opacity:.75; font-size:12px; padding:6px 2px 20px }
    .hint-kbd{ font:600 11px var(--font-mono); background:#fff7; border:1px solid var(--ridge); padding:2px 6px; border-radius:6px }

    /* Small */
    @media (max-width: 640px){
      .wrap{ padding:16px }
      .input{ grid-template-columns: 38px 1fr 84px }
      .btn{ padding:0 10px }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">ðŸ§¶</div>
      <div>
        <h1>Mildred</h1>
        <div class="sub">Knitting chat â€” attach photos/files, drag & drop, mobile camera capture</div>
      </div>
    </header>

    <main>
      <div class="thread" id="thread" role="log" aria-live="polite" aria-label="Conversation" aria-busy="false"></div>

      <div class="inputbar" role="region" aria-label="Knitting input">
        <div class="chips" role="group" aria-label="Quick prompts">
          <button class="chip" data-insert="Cast-on">Castâ€‘on</button>
          <button class="chip" data-insert="Fix mistake">Fix mistake</button>
          <button class="chip" data-insert="Gauge math">Gauge math</button>
          <button class="chip" data-insert="Translate pattern">Translate pattern</button>
        </div>

        <div class="input dropzone" id="dropzone">
          <button class="iconbtn attach" id="attachBtn" aria-label="Attach photo or file">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M7 13.5V7.75a4.25 4.25 0 1 1 8.5 0v7a3.25 3.25 0 1 1-6.5 0V8.5a1 1 0 1 1 2 0v6.25a1.25 1.25 0 1 0 2.5 0v-7a2.25 2.25 0 1 0-4.5 0v5.75"/>
            </svg>
          </button>

          <textarea rows="1" id="msg" placeholder="Ask about garter stitch, German short rows, or graftingâ€¦" aria-label="Message"></textarea>
          <button class="btn" id="sendBtn" aria-label="Send message">Send âˆ¨</button>

          <!-- Hidden file input; capture opens camera on mobile -->
          <input id="filePicker" type="file" hidden multiple
            accept="image/*,.pdf,.txt,.md,.csv,.json,.doc,.docx"
            capture="environment">
        </div>

        <!-- Attachment previews -->
        <div class="previews" id="previews" aria-live="polite"></div>
        <div id="srStatus" class="sr-only" aria-live="polite"></div>
      </div>
    </main>

    <footer>
      Tip: drag files onto the input, click the paperclip, or press <span class="hint-kbd">Ctrl/âŒ˜+U</span> to attach. Press <span class="hint-kbd">Enter</span> to send; <span class="hint-kbd">Shift+Enter</span> makes a new line.
    </footer>
  </div>

  <script>
    const filePicker = document.getElementById('filePicker');
    const attachBtn  = document.getElementById('attachBtn');
    const previewsEl = document.getElementById('previews');
    const dropzone   = document.getElementById('dropzone');
    const sendBtn    = document.getElementById('sendBtn');
    const msg        = document.getElementById('msg');
    const srStatus   = document.getElementById('srStatus');
    const thread     = document.getElementById('thread');
    const sendIdleLabel = sendBtn.textContent;

    let attachments = []; // { id, file, url, type, uploading, progress }
    let isComposing = false; // IME safety
    let sending = false;

    attachBtn.addEventListener('click', () => filePicker.click());
    filePicker.addEventListener('change', () => addFiles([...filePicker.files]));

    ['dragenter','dragover'].forEach(evt =>
      dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.add('dragover'); })
    );
    ['dragleave','drop'].forEach(evt =>
      dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.remove('dragover'); })
    );
    dropzone.addEventListener('drop', e => addFiles([...e.dataTransfer.files]));

    // Optional: Ctrl/Cmd+U to attach
    document.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'u') { e.preventDefault(); filePicker.click(); }
    });

    // Chips insert
    document.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const txt = chip.dataset.insert || chip.textContent.trim();
        insertAtCursor(msg, (msg.value ? txt + ': ' : txt + ': '));
        msg.focus();
      });
    });

    // Enter to send; Shift+Enter = newline
    msg.addEventListener('compositionstart', () => isComposing = true);
    msg.addEventListener('compositionend',   () => isComposing = false);
    msg.addEventListener('keydown', (e) => {
      if (isComposing || sending) return;
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        triggerSend();
      }
    });

    function insertAtCursor(el, text){
      const start = el.selectionStart ?? el.value.length;
      const end = el.selectionEnd ?? el.value.length;
      const before = el.value.slice(0, start);
      const after  = el.value.slice(end);
      el.value = before + text + after;
      const pos = start + text.length;
      el.setSelectionRange(pos, pos);
      el.dispatchEvent(new Event('input'));
    }

    function addFiles(files){
      let added = 0;
      for(const file of files){
        if (file.size > 12 * 1024 * 1024) { alert(`${file.name} is over 12MB`); continue; }
        const id = crypto.randomUUID();
        const url = file.type.startsWith('image/') ? URL.createObjectURL(file) : '';
        attachments.push({ id, file, url, type: file.type, uploading:false, progress:0 });
        added++;
      }
      filePicker.value = '';
      renderPreviews();
      if (added) announce(`${added} attachment${added>1?'s':''} added`);
    }

    function renderPreviews(){
      previewsEl.innerHTML = '';
      for(const a of attachments){
        const el = document.createElement('div');
        el.className = 'preview';
        el.dataset.id = a.id;

        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        if (a.url) {
          const img = new Image(); img.src = a.url; img.alt = '';
          thumb.appendChild(img);
        } else {
          thumb.textContent = ext(a.file.name);
        }

        const info = document.createElement('div'); info.className = 'info';
        const name = document.createElement('span'); name.className='name'; name.textContent = a.file.name;
        const size = document.createElement('span'); size.className='size'; size.textContent = humanSize(a.file.size);
        info.append(name, size);

        const bar = document.createElement('div');
        bar.className = 'bar';
        const inner = document.createElement('span');
        bar.appendChild(inner);
        if (a.uploading) { inner.style.setProperty('--p', a.progress + '%'); } else { bar.style.display='none'; }

        const remove = document.createElement('button'); remove.className='remove'; remove.setAttribute('aria-label', `Remove ${a.file.name}`); remove.textContent = 'Ã—';
        remove.onclick = () => { URL.revokeObjectURL(a.url); attachments = attachments.filter(x => x.id !== a.id); renderPreviews(); updateAttachmentIndicators(); };

        el.append(thumb, info, bar, remove);
        previewsEl.appendChild(el);
      }
      updateAttachmentIndicators();
    }

    function updateAttachmentIndicators(){
      const count = attachments.length;
      if (count > 0) {
        attachBtn.setAttribute('data-count', String(count));
        attachBtn.setAttribute('aria-label', `Attach photo or file â€” ${count} attached`);
        sendBtn.setAttribute('data-count', String(count));
        sendBtn.setAttribute('aria-label', `Send message with ${count} attachment${count>1?'s':''}`);
      } else {
        attachBtn.removeAttribute('data-count');
        attachBtn.setAttribute('aria-label', 'Attach photo or file');
        sendBtn.removeAttribute('data-count');
        sendBtn.setAttribute('aria-label', 'Send message');
      }
    }

    function announce(text){ srStatus.textContent = ''; requestAnimationFrame(()=> srStatus.textContent = text); }

    function fillBubble(el, text){
      el.innerHTML = '';
      const parts = String(text ?? '').split('\n');
      parts.forEach((part, idx) => {
        if (idx) el.appendChild(document.createElement('br'));
        el.appendChild(document.createTextNode(part));
      });
    }

    function appendMessage(role, text, options = {}){
      if (!thread) return null;
      const entry = document.createElement('div');
      entry.className = `msg ${role}`;
      if (options.pending) entry.classList.add('pending');
      if (options.error) entry.classList.add('error');

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      fillBubble(bubble, text);
      entry.appendChild(bubble);

      if (Array.isArray(options.attachments) && options.attachments.length){
        const list = document.createElement('ul');
        list.className = 'files';
        for (const file of options.attachments){
          const item = document.createElement('li');
          const sizeText = typeof file.size === 'number' ? ` â€¢ ${humanSize(file.size)}` : '';
          item.textContent = `${file.name}${sizeText}`;
          list.appendChild(item);
        }
        entry.appendChild(list);
      }

      thread.appendChild(entry);
      thread.scrollTop = thread.scrollHeight;
      return { entry, bubble };
    }

    function updateAssistantMessage(target, text, isError = false){
      if (!target) return;
      fillBubble(target.bubble, text);
      target.entry.classList.toggle('pending', false);
      target.entry.classList.toggle('error', Boolean(isError));
    }

    function setSending(state){
      sending = state;
      sendBtn.disabled = state;
      if (state){
        sendBtn.setAttribute('aria-busy', 'true');
        sendBtn.textContent = 'Sendingâ€¦';
        if (thread) thread.setAttribute('aria-busy', 'true');
      } else {
        sendBtn.removeAttribute('aria-busy');
        sendBtn.textContent = sendIdleLabel;
        if (thread) thread.setAttribute('aria-busy', 'false');
      }
    }

    function ext(name){ const m = name.split('.').pop(); return (m||'FILE').slice(0,4).toUpperCase(); }
    function humanSize(b){ const u=['B','KB','MB','GB']; let i=0; while(b>=1024 && i<u.length-1){ b/=1024; i++; } return `${b.toFixed(b<10&&i?1:0)} ${u[i]}`; }

    // Send logic in a reusable function
    async function triggerSend(){
      if (sending) return;
      const prompt = msg.value.trim();
      if (!prompt){
        announce('Please type a message before sending');
        msg.focus();
        return;
      }

      const originalValue = msg.value;
      const filesMeta = attachments.map(a => ({ name: a.file.name, size: a.file.size }));

      setSending(true);
      announce('Sending message');

      appendMessage('user', prompt, { attachments: filesMeta });
      msg.value = '';

      const assistantMessage = appendMessage('assistant', 'Thinkingâ€¦', { pending: true });

      if (attachments.length){
        for (const a of attachments){ a.uploading = true; a.progress = 10; }
        renderPreviews();
        for (const a of attachments){
          for (let p=10; p<=100; p+=30){
            await new Promise(r=>setTimeout(r,130));
            a.progress = p;
            renderPreviews();
          }
        }
      }

      let success = false;
      try {
        const resp = await fetch('/api/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, files: filesMeta })
        });

        if (!resp.ok) {
          const errText = await resp.text();
          throw new Error(errText || `Request failed with status ${resp.status}`);
        }

        let text = await resp.text();
        text = text.trim() || 'I did not receive a reply.';
        updateAssistantMessage(assistantMessage, text);
        announce('Mildred replied');
        success = true;
      } catch (error) {
        console.error('Send error', error);
        updateAssistantMessage(assistantMessage, 'Sorry, I had trouble reaching Mildred. Please try again in a moment.', true);
        announce('Message failed to send');
        msg.value = originalValue;
      } finally {
        if (success){
          for (const a of attachments){ if (a.url) URL.revokeObjectURL(a.url); }
          attachments = [];
        } else {
          for (const a of attachments){ a.uploading = false; a.progress = 0; }
        }
        renderPreviews();
        setSending(false);
        msg.focus();
      }
    }

    appendMessage('assistant', 'Hi! I\'m Mildred â€” share what you\'re knitting and I\'ll help with yarn math, fixes, and more.');

    // Buttons
    sendBtn.addEventListener('click', triggerSend);
  </script>
</body>
</html>
